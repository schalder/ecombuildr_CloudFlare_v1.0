<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#10B981" />
    
    <!-- Performance optimizations -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://fhqwacmokbtbspkxjixf.supabase.co" />
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />
    
    <!-- Critical resource hints -->
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" />
    <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <!-- Critical CSS for image optimization -->
    <style>
      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }
      .image-container { position: relative; overflow: hidden; background-color: hsl(var(--muted)); }
      .image-container::before { content: ''; display: block; width: 100%; height: 0; padding-bottom: var(--aspect-ratio, 56.25%); }
      .image-container img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s ease; }
      .loading-shimmer { background: linear-gradient(90deg, hsl(var(--muted)) 25%, hsl(var(--muted-foreground) / 0.1) 50%, hsl(var(--muted)) 75%); background-size: 200% 100%; animation: shimmer 2s infinite; }
      picture { display: block; width: 100%; height: 100%; }
      img[width][height] { aspect-ratio: attr(width) / attr(height); }
    </style>
    
    <!-- Static snapshot bootstrap: load server-rendered HTML before SPA -->
    <script>
      (function () {
        try {
          const params = new URLSearchParams(window.location.search);
          const sf = params.get('sf');
          const p = window.location.pathname;
          const isAdmin = p.includes('/dashboard') || p.includes('/admin') || p.includes('/builder') || p.includes('/edit');

          if (sf === '0' || sf === 'false' || isAdmin) { console.debug('[SSR bootstrap] Skipped (admin or sf=0)'); return; }

          if (window.__servedStatic) return; window.__servedStatic = true;

          const url = `https://fhqwacmokbtbspkxjixf.supabase.co/functions/v1/serve-static-page?domain=${encodeURIComponent(window.location.hostname)}&path=${encodeURIComponent(p)}`;
          console.debug('[SSR bootstrap] Fetching snapshot:', url);

          const controller = new AbortController();
          const timeoutId = setTimeout(() => { console.warn('[SSR bootstrap] Timeout, falling back to SPA'); controller.abort(); }, 5000);

          fetch(url, { method: 'GET', signal: controller.signal, cache: 'no-store' })
            .then(async (res) => {
              clearTimeout(timeoutId);
              const ct = res.headers.get('content-type') || '';
              const text = await res.text();
              console.debug('[SSR bootstrap] Status:', res.status, 'CT:', ct, 'Len:', text.length);
              if (!res.ok) return;
              const looksHTML = ct.includes('text/html') || /<html[\s>]/i.test(text);
              if (looksHTML && text && !/^Page not found|Page temporarily unavailable$/i.test(text.trim())) {
                document.open();
                document.write(text);
                document.close();
              }
            })
            .catch((e) => { console.warn('[SSR bootstrap] Error, SPA fallback', e); });
        } catch (e) { console.warn('[SSR bootstrap] Failed', e); }
      })();
    </script>

    <!-- Dynamic SEO tags will be loaded here -->
    <script>
      (function() {
        // Get current domain and path
        const currentDomain = window.location.hostname;
        const currentPath = window.location.pathname;
        const cacheKey = `seo_${currentDomain}${currentPath}`;
        
        // Check cache first (1 hour expiry)
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
          try {
            const { data, timestamp } = JSON.parse(cached);
            if (Date.now() - timestamp < 3600000) { // 1 hour
              updateSEOTags(data);
              return;
            }
          } catch (e) {
            localStorage.removeItem(cacheKey);
          }
        }

        // Always fetch SEO data from seo-prerender function for consistency
        fetchSEOFromPrerender(currentDomain, currentPath).then(seoData => {
          if (seoData) {
            updateSEOTags(seoData);
            // Cache the result
            localStorage.setItem(cacheKey, JSON.stringify({
              data: seoData,
              timestamp: Date.now()
            }));
          }
        }).catch(console.error);

        function fetchSEOFromPrerender(domain, path) {
          const url = `https://fhqwacmokbtbspkxjixf.supabase.co/functions/v1/seo-prerender?domain=${encodeURIComponent(domain)}&path=${encodeURIComponent(path)}&format=json`;
          return fetch(url)
            .then(response => response.json())
            .then(data => data.success ? data.seo : null)
            .catch(() => null);
        }

        function updateSEOTags(seo) {
          if (!seo) return;

          // Update title
          if (seo.title) {
            document.title = seo.title;
            updateOrCreateMeta('og:title', seo.title, 'property');
            updateOrCreateMeta('twitter:title', seo.title, 'name');
          }

          // Update description
          if (seo.description) {
            updateOrCreateMeta('description', seo.description);
            updateOrCreateMeta('og:description', seo.description, 'property');
            updateOrCreateMeta('twitter:description', seo.description, 'name');
          }

          // Update keywords
          if (seo.keywords && Array.isArray(seo.keywords)) {
            updateOrCreateMeta('keywords', seo.keywords.join(', '));
          }

          // Update robots
          if (seo.robots) {
            updateOrCreateMeta('robots', seo.robots);
          }

          // Update canonical
          if (seo.canonical) {
            updateOrCreateLink('canonical', seo.canonical);
            updateOrCreateMeta('og:url', seo.canonical, 'property');
          }

          // Update images
          if (seo.og_image) {
            updateOrCreateMeta('og:image', seo.og_image, 'property');
            updateOrCreateMeta('twitter:image', seo.og_image, 'name');
          }

          // Set default Open Graph and Twitter properties
          updateOrCreateMeta('og:type', 'website', 'property');
          updateOrCreateMeta('og:site_name', 'EcomBuildr', 'property');
          updateOrCreateMeta('twitter:card', 'summary_large_image', 'name');
        }

        function updateOrCreateMeta(name, content, property = 'name') {
          const selector = `meta[${property}="${name}"]`;
          let meta = document.querySelector(selector);
          if (!meta) {
            meta = document.createElement('meta');
            meta.setAttribute(property, name);
            document.head.appendChild(meta);
          }
          meta.setAttribute('content', content);
        }

        function updateOrCreateLink(rel, href) {
          const selector = `link[rel="${rel}"]`;
          let link = document.querySelector(selector);
          if (!link) {
            link = document.createElement('link');
            link.setAttribute('rel', rel);
            document.head.appendChild(link);
          }
          link.setAttribute('href', href);
        }
      })();
    </script>
    
    <!-- Dynamic SEO tags are managed in code per-page via setSEO function -->
    <!-- Favicon is set dynamically per website/funnel in setSEO() function -->
    <!-- Font Awesome for icon lists -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
